---
harness('inviqa/node-spa'):
  description: A docker based development environment for SPA apps built by tools run in node
  require:
    services:
      - proxy
    confd:
      - harness:/
---
command('frontend build'):
  env:
    COMPOSE_PROJECT_NAME: = @('namespace')
  exec: |
    #!bash(workspace:/)|@
    passthru docker-compose exec -u node node app build:frontend
---
attributes:

  app:
    dist_path: /app/build
    node_web_port: 80
    services:
      - chrome
      #- lighthouse

  backend:
    path: /app
    build:
      when: 'true'
      steps: []
    start_dev:
      steps:
        - passthru yarn install
        - yarn dev

  frontend:
    path: /app
    build:
      when: 'true'
      steps:
        - passthru yarn install
        - passthru yarn build

  services:
    node:
      environment:
        HOST_OS_FAMILY: = @('host.os')
        APP_NAME: = @('workspace.name')
        APP_HOST: = @('hostname')
    nginx:
      environment:
        APP_HOST: = @('hostname')
      # used to set site specific configurations under server directive
      site:
        conf: []
      # used to set nginx global configurations under http directive
      global:
        conf: []
      # used to limit what is copied into an Nginx static-built image
      copy_directories:
       - = @('app.web_directory')

  pipeline:
    preview:
      resources:
        memory:
          nginx: "64Mi"
          node: "1024Mi"

---
import:
  - harness/config/*.yml
  - harness/attributes/*.yml
  - harness/attributes/environment/={env('MY127WS_ENV','local')}.yml
