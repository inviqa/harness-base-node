#!/usr/bin/env bash

node_enabled()
{
    if [ "$APP_BUILD" = dynamic ]; then
        [ -f .my127ws/.flag-node-built ]
    else
        [ -n "$(docker-compose ps --quiet node)" ]
    fi
}

enable_all()
{
    local IS_BUILT=no
    local HAS_FLAG=no

    if [ -f .my127ws/.flag-built ]; then
        HAS_FLAG=yes
        IS_BUILT=yes
        # If the containers no longer exist, we need to rebuild them
        if [ -z "$(docker-compose ps --quiet)" ]; then
            IS_BUILT=no
        fi
    fi

    passthru ws networks external
    if [ "$IS_BUILT" = no ]; then
      if [ "$HAS_FLAG" = no ]; then
          # remove all services, keeping node if considered built
          if node_enabled; then
              passthru "docker-compose ps --services | grep -v -Fxe node | xargs docker-compose rm --stop --"
          else
              passthru docker-compose down
          fi
      fi

        if [ "$HAS_ASSETS" = yes ]; then
            ws assets download
        fi

        "$APP_BUILD"

        initial_start

        touch .my127ws/.flag-built
    else
        if [ "$APP_BUILD" = dynamic ] && [ "$USE_MUTAGEN" = yes ]; then
            passthru echo "USE_MUTAGEN YES!!"
            passthru ws mutagen resume
        fi

        passthru docker-compose up -d
        passthru docker-compose exec -T -u node node app welcome
    fi
}

dynamic_node()
{
    if node_enabled; then
      # ensure node is started
      if [ -z "$(docker-compose ps --quiet node)" ]; then
          passthru docker-compose up -d node
      fi
      return;
    fi

    # we synchronise then stop mutagen to avoid impacting CPU usage during the build
    if [ "$USE_MUTAGEN" = 'yes' ]; then
        passthru echo "USE_MUTAGEN YES!!"
        passthru ws mutagen start
        passthru ws mutagen pause
    fi

    find .my127ws/docker/image/ -type d ! -perm u+rwx,go+rx,o-w -exec chmod u+rwx,go+rx,o-w {} +

    passthru docker-compose up --build -d node
    # passthru docker-compose exec -T -u node node app build

    if [ "$USE_MUTAGEN" = yes ]; then
        ws mutagen resume
    fi

    touch .my127ws/.flag-node-built
}


dynamic()
{
    ws external-images pull

    dynamic_node

    passthru "docker-compose config --services | xargs docker-compose build"

}

static()
{
    ws app build
}

initial_start()
{
    # Bring up all services
    passthru "docker-compose config --services | xargs docker-compose up -d"

    if [ "$APP_BUILD" = 'dynamic' ]; then
        passthru docker-compose exec -T -u node node app build
    fi

    passthru docker-compose exec -T -u node node app init
}

"enable_$1"
